<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ã‚„ã•ã—ã„ãƒ‰ãƒƒãƒˆã‚¿ã‚¤ãƒãƒ¼</title>
  <style>
    :root{ --dot-size:40px; --gap:10px; }
    body{
      font-family:"Rounded Mplus 1c","Hiragino Maru Gothic ProN",sans-serif;
      padding:24px; background:#fffbe6; color:#222; text-align:center
    }
    h1{ font-size:1.6rem; margin:0 0 16px; color:#d17b00 }
    .controls, .mode{
      display:flex; flex-wrap:wrap; justify-content:center; gap:12px; margin-bottom:12px
    }
    label{ font-weight:600 }
    input[type=number]{ font-size:1.2rem; width:120px; padding:10px; border-radius:12px;
      border:2px solid #ffa726; text-align:center }
    button{ font-size:1.2rem; padding:12px 20px; border-radius:16px; border:0;
      background:#ff9800; color:#fff; cursor:pointer; box-shadow:2px 2px 4px rgba(0,0,0,.2) }
    button.secondary{ background:#8d6e63 }
    button:active{ transform:scale(0.95) }
    .status{ font-size:1.3rem; margin:8px 0 12px; color:#333 }
    .done{ font-size:1.6rem; font-weight:700; color:#2e7d32; min-height:1.6em }
    .dots{
      display:grid; grid-template-columns: repeat(10, var(--dot-size));
      gap:var(--gap); max-width:95%; margin:0 auto; justify-content:center
    }
    .dot{
      width:var(--dot-size); height:var(--dot-size); border-radius:50%;
      background:#4caf50; border:2px solid #2e7d32;
      transition:opacity .25s, transform .25s, background .25s, border-color .25s
    }
    /* æ¶ˆãˆãŸï¼ˆæœªé”æˆï¼‰çŠ¶æ…‹ï¼šæ˜åº¦å·®ã¨æ ã§åˆ¤åˆ¥ã—ã‚„ã™ã */
    .dot.hidden{ background:#cfd8dc; border-color:#90a4ae; opacity:0.7 }
    /* 10ã®ã¾ã¨ã¾ã‚Šã®è¦–è¦šæ‰‹ãŒã‹ã‚Šï¼ˆå…ˆé ­ã«è–„ã„ç ´ç·šæ ï¼‰ */
    .dot:nth-child(10n+1){ outline:2px dashed rgba(0,0,0,0.15); outline-offset:-4px }
    .info{ margin-top:14px; font-size:1.05rem; color:#555 }
    footer{ margin-top:20px; color:#888; font-size:0.9rem }
    @media (max-width:420px){ :root{ --dot-size:28px; --gap:6px } }
    @media (prefers-reduced-motion: reduce){
      .dot{ transition:none !important; }
    }
  </style>
</head>
<body>
  <h1>ã‚„ã•ã—ã„ãƒ‰ãƒƒãƒˆã‚¿ã‚¤ãƒãƒ¼</h1>

  <div class="mode" role="radiogroup" aria-label="ãƒ¢ãƒ¼ãƒ‰é¸æŠ">
    <label><input type="radio" name="mode" value="down" checked> æ¸›ã‚‹ï¼ˆã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ï¼‰</label>
    <label><input type="radio" name="mode" value="up"> ãµãˆã‚‹ï¼ˆã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—ï¼‰</label>
  </div>

  <div class="controls">
    <label for="count">ãƒ‰ãƒƒãƒˆæ•°</label>
    <input id="count" type="number" min="1" max="3600" value="30" />
    <button id="start">â–¶ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
    <button id="pause" class="secondary">â¸ä¸€æ™‚åœæ­¢</button>
    <button id="reset" class="secondary">ğŸ”„ãƒªã‚»ãƒƒãƒˆ</button>
  </div>

  <div class="status" id="statusLine"><span id="label">æ®‹ã‚Šãƒ‰ãƒƒãƒˆ</span>ï¼š<strong id="primaryNumber">30</strong></div>
  <div class="done" id="doneText" aria-live="polite"></div>

  <div class="dots" id="dots" aria-live="polite" aria-label="ãƒ‰ãƒƒãƒˆè¡¨ç¤ºé ˜åŸŸ"></div>

  <div class="info">
    â–¶ã§ ã¯ã˜ã¾ã‚‹ / â¸ã§ ã¨ã¾ã‚‹ / ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ã§ã‚‚é–‹å§‹ãƒ»åœæ­¢ã§ãã¾ã™ã€‚<br>
    çµ‚äº†æ™‚ã¯ã‚¢ãƒ©ãƒ¼ãƒ ãŒ<strong>3å›</strong>é³´ã‚Šã¾ã™ã€‚
  </div>
  <footer>ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã—ã¦ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã„ã¦ãã ã•ã„ã€‚</footer>

  <script>
    (function(){
      const dotsContainer = document.getElementById('dots');
      const countInput = document.getElementById('count');
      const startBtn = document.getElementById('start');
      const pauseBtn = document.getElementById('pause');
      const resetBtn = document.getElementById('reset');
      const labelEl = document.getElementById('label');
      const primaryNumberEl = document.getElementById('primaryNumber');
      const doneText = document.getElementById('doneText');
      const modeRadios = document.querySelectorAll('input[name="mode"]');

      let total = norm(parseInt(countInput.value,10) || 30);
      let timer = null;
      let mode = getMode();
      let nextIndex = (mode === 'down') ? total - 1 : 0; // down: éš ã™æ–¹å‘, up: è¦‹ã›ã‚‹æ–¹å‘
      let audioCtx = null; // WebAudio

      function norm(v){ return Math.max(1, Math.min(3600, v)); }

      function getMode(){
        const checked = Array.from(modeRadios).find(r => r.checked);
        return checked ? checked.value : 'down';
      }

      function buildDots(n){
        dotsContainer.innerHTML = '';
        // ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—ã¯ã€Œæœ€åˆãœã‚“ã¶hiddenï¼ˆç°ï¼‰ã€â†’é€²ã‚€ã»ã©ç·‘ãŒå¢—ãˆã‚‹
        const startHidden = (mode === 'up');
        for(let i=0;i<n;i++){
          const el = document.createElement('span');
          el.className = 'dot' + (startHidden ? ' hidden' : '');
          el.setAttribute('data-index', i);
          dotsContainer.appendChild(el);
        }
        // è¡¨ç¤ºãƒ©ãƒ™ãƒ«
        if(mode === 'down'){
          labelEl.textContent = 'æ®‹ã‚Šãƒ‰ãƒƒãƒˆ';
          primaryNumberEl.textContent = n;
          nextIndex = n - 1;
        }else{
          labelEl.textContent = 'çµŒéãƒ‰ãƒƒãƒˆ';
          primaryNumberEl.textContent = 0;
          nextIndex = 0;
        }
        doneText.textContent = '';
      }

      function updateUIAfterStep(){
        if(mode === 'down'){
          const remaining = Math.max(0, nextIndex + 1);
          primaryNumberEl.textContent = remaining;
          if(remaining === 0){ finish(); }
        }else{
          const elapsed = Math.min(total, nextIndex);
          primaryNumberEl.textContent = elapsed;
          if(elapsed >= total){ finish(); }
        }
      }

      function tick(){
        if(mode === 'down'){
          if(nextIndex < 0){ stopTimer(); return; }
          const dot = dotsContainer.querySelector('.dot[data-index="'+nextIndex+'"]');
          if(dot){ dot.classList.add('hidden'); }
          nextIndex--;
        }else{
          if(nextIndex >= total){ stopTimer(); return; }
          const dot = dotsContainer.querySelector('.dot[data-index="'+nextIndex+'"]');
          if(dot){ dot.classList.remove('hidden'); }
          nextIndex++;
        }
        updateUIAfterStep();
      }

      function startTimer(){
        if(timer) return;
        // åˆå›é–‹å§‹æ™‚ã«AudioContextã‚’è§£æ”¾ï¼ˆiOSã®åˆ¶ç´„å¯¾ç­–ï¼‰
        try{
          if(!audioCtx){
            const Ctx = window.AudioContext || window.webkitAudioContext;
            if(Ctx){ audioCtx = new Ctx(); }
          }
          audioCtx?.resume?.();
        }catch(e){}
        timer = setInterval(tick, 1000);
      }

      function stopTimer(){
        if(timer){ clearInterval(timer); timer = null; }
      }

      function finish(){
        stopTimer();
        doneText.textContent = 'ãŠã‚ã‚Šï¼';
        playAlarm3(); // â† 3å›ç¢ºå®Ÿã«é³´ã‚‰ã™
      }

      // WebAudioã§3å›ãƒ“ãƒ¼ãƒ—ï¼ˆ0.6ç§’é–“éš”ï¼‰
      function playAlarm3(){
        try{
          if(!audioCtx){
            const Ctx = window.AudioContext || window.webkitAudioContext;
            if(Ctx){ audioCtx = new Ctx(); }
          }
          if(!audioCtx) return; // éå¯¾å¿œãªã‚‰è«¦ã‚ï¼ˆã»ã¼ç¨€ï¼‰

          const now = audioCtx.currentTime;
          // 3ç™ºã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆå„0.25ç§’ã€é–“éš”0.6ç§’ï¼‰
          for(let i=0;i<3;i++){
            const t = now + i * 0.6;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'sine';
            osc.frequency.value = 880; // A5ä»˜è¿‘
            gain.gain.setValueAtTime(0.0001, t);
            gain.gain.exponentialRampToValueAtTime(0.3, t + 0.01);

            osc.connect(gain);
            gain.connect(audioCtx.destination);

            osc.start(t);
            osc.stop(t + 0.25);
          }
        }catch(e){
          // æœ€æ‚ªã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆç„¡éŸ³ã«ãªã‚‹ã‚ˆã‚Šãƒã‚·ï¼‰
          console.warn('Alarm fallback', e);
        }
      }

      // Event bindings
      startBtn.addEventListener('click', startTimer);
      pauseBtn.addEventListener('click', stopTimer);
      resetBtn.addEventListener('click', ()=>{
        stopTimer();
        total = norm(parseInt(countInput.value,10) || 30);
        mode = getMode();
        buildDots(total);
      });
      countInput.addEventListener('change', ()=>{
        total = norm(parseInt(countInput.value,10) || 1);
        countInput.value = total;
        mode = getMode();
        buildDots(total);
      });
      modeRadios.forEach(r=>{
        r.addEventListener('change', ()=>{
          mode = getMode();
          buildDots(total);
        });
      });

      window.addEventListener('keydown', (e)=>{
        if(e.code === 'Space'){
          e.preventDefault();
          if(timer) stopTimer(); else startTimer();
        }
      });

      // åˆæœŸåŒ–
      buildDots(total);
    })();
  </script>
</body>
</html>
